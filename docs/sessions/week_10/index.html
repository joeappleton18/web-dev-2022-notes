<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Week 10 - Hosting, Rules and Cloud Functions</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/web-dev-2022-notes/assets/css/0.styles.bfec3465.css" as="style"><link rel="preload" href="/web-dev-2022-notes/assets/js/app.1aee1c2e.js" as="script"><link rel="preload" href="/web-dev-2022-notes/assets/js/2.12b928b3.js" as="script"><link rel="preload" href="/web-dev-2022-notes/assets/js/25.3ccb054f.js" as="script"><link rel="prefetch" href="/web-dev-2022-notes/assets/js/10.35fb8086.js"><link rel="prefetch" href="/web-dev-2022-notes/assets/js/11.ec905c8d.js"><link rel="prefetch" href="/web-dev-2022-notes/assets/js/12.63e7298f.js"><link rel="prefetch" href="/web-dev-2022-notes/assets/js/13.dd23a039.js"><link rel="prefetch" href="/web-dev-2022-notes/assets/js/14.c5db446d.js"><link rel="prefetch" href="/web-dev-2022-notes/assets/js/15.1ae5d25b.js"><link rel="prefetch" href="/web-dev-2022-notes/assets/js/16.817f1300.js"><link rel="prefetch" href="/web-dev-2022-notes/assets/js/17.5e71fda9.js"><link rel="prefetch" href="/web-dev-2022-notes/assets/js/18.c40d3793.js"><link rel="prefetch" href="/web-dev-2022-notes/assets/js/19.b383817b.js"><link rel="prefetch" href="/web-dev-2022-notes/assets/js/20.ad8a4a4c.js"><link rel="prefetch" href="/web-dev-2022-notes/assets/js/21.c4f4d6f1.js"><link rel="prefetch" href="/web-dev-2022-notes/assets/js/22.b5799744.js"><link rel="prefetch" href="/web-dev-2022-notes/assets/js/23.050c7264.js"><link rel="prefetch" href="/web-dev-2022-notes/assets/js/24.838d4ae4.js"><link rel="prefetch" href="/web-dev-2022-notes/assets/js/26.5d9327b9.js"><link rel="prefetch" href="/web-dev-2022-notes/assets/js/27.77ebcbaf.js"><link rel="prefetch" href="/web-dev-2022-notes/assets/js/28.d1bab98b.js"><link rel="prefetch" href="/web-dev-2022-notes/assets/js/29.bb340f0e.js"><link rel="prefetch" href="/web-dev-2022-notes/assets/js/3.2791bc7f.js"><link rel="prefetch" href="/web-dev-2022-notes/assets/js/30.12722bb0.js"><link rel="prefetch" href="/web-dev-2022-notes/assets/js/31.2f8c6231.js"><link rel="prefetch" href="/web-dev-2022-notes/assets/js/32.e43ffa1a.js"><link rel="prefetch" href="/web-dev-2022-notes/assets/js/33.f2f8f856.js"><link rel="prefetch" href="/web-dev-2022-notes/assets/js/34.c2cdc7f5.js"><link rel="prefetch" href="/web-dev-2022-notes/assets/js/35.00190a6e.js"><link rel="prefetch" href="/web-dev-2022-notes/assets/js/36.fec07411.js"><link rel="prefetch" href="/web-dev-2022-notes/assets/js/37.4dcb869a.js"><link rel="prefetch" href="/web-dev-2022-notes/assets/js/38.05b01327.js"><link rel="prefetch" href="/web-dev-2022-notes/assets/js/39.0a86fa82.js"><link rel="prefetch" href="/web-dev-2022-notes/assets/js/4.67a616a1.js"><link rel="prefetch" href="/web-dev-2022-notes/assets/js/40.4480b396.js"><link rel="prefetch" href="/web-dev-2022-notes/assets/js/41.9417ebec.js"><link rel="prefetch" href="/web-dev-2022-notes/assets/js/42.f2012ab8.js"><link rel="prefetch" href="/web-dev-2022-notes/assets/js/43.19e5cd0d.js"><link rel="prefetch" href="/web-dev-2022-notes/assets/js/44.da5f661c.js"><link rel="prefetch" href="/web-dev-2022-notes/assets/js/45.a0a4c54f.js"><link rel="prefetch" href="/web-dev-2022-notes/assets/js/5.349be753.js"><link rel="prefetch" href="/web-dev-2022-notes/assets/js/6.ae929633.js"><link rel="prefetch" href="/web-dev-2022-notes/assets/js/7.25c6abbd.js"><link rel="prefetch" href="/web-dev-2022-notes/assets/js/8.8a463877.js"><link rel="prefetch" href="/web-dev-2022-notes/assets/js/9.336d28d4.js">
    <link rel="stylesheet" href="/web-dev-2022-notes/assets/css/0.styles.bfec3465.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/web-dev-2022-notes/" class="home-link router-link-active"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Overview</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/web-dev-2022-notes/" aria-current="page" class="sidebar-link">Course Overview</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/web-dev-2022-notes/#teaching-strategy" class="sidebar-link">Teaching Strategy</a></li><li class="sidebar-sub-header"><a href="/web-dev-2022-notes/#technologies-we-will-be-using" class="sidebar-link">Technologies we will be using:</a></li><li class="sidebar-sub-header"><a href="/web-dev-2022-notes/#how-you-will-be-assessed" class="sidebar-link">How you will be assessed</a></li><li class="sidebar-sub-header"><a href="/web-dev-2022-notes/#weekly-topics" class="sidebar-link">Weekly Topics</a></li><li class="sidebar-sub-header"><a href="/web-dev-2022-notes/#using-these-notes" class="sidebar-link">Using these notes</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Assessments</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Week 1 - The latest version of JavaScript</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Week 2 - Introducing React</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Week 3 - Loops</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="week-10-hosting-rules-and-cloud-functions"><a href="#week-10-hosting-rules-and-cloud-functions" class="header-anchor">#</a> Week 10 - Hosting, Rules and Cloud Functions</h1> <p>Welcome to week 10, our final week of formal delivery. This week we are going to consider the following:</p> <ul><li>How can I host my application?</li> <li>How can I secure my database?</li></ul> <div class="custom-block warning"><p class="custom-block-title">session dependencies=</p> <h2 id="session-dependencies"><a href="#session-dependencies" class="header-anchor">#</a> Session Dependencies</h2> <p>[Make sure that you have the latest of the ongoing class, fitness tracker, project. **The notes for this week refer extensively to this project:</p> <p><code>git clone -b week-9-solutions https://github.com/joeappleton18/running-contemp-web-app-solutions.git</code></p> <p>This week's, and future, setups are a little more involved. You will need to ensure that you add your own firebase credentials. The <code>README.md</code> file on my version of the fitness tracker walks you through how to do this.</p></div> <h3 id="essential-reading"><a href="#essential-reading" class="header-anchor">#</a> Essential Reading ðŸ“•</h3> <div class="custom-block warning"><p class="custom-block-title">essential reading</p> <p>The firebase documentation on:</p> <ul><li><a href="https://firebase.google.com/docs/hosting" target="_blank" rel="noopener noreferrer">Hosting<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://firebase.google.com/docs/rules" target="_blank" rel="noopener noreferrer">security rules<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div> <h2 id="introduction"><a href="#introduction" class="header-anchor">#</a> Introduction</h2> <p>This week we are going to push things to the next level and make our application production-ready by securing our database. You will also learn how to deploy your application to hosting. To achieve all of this we will need to install the firebase command line interface.This is as far as we are going to take things! I appreciate our application is not finished. However, it's served its purpose in teaching you the basics of React and Firebase!</p> <h2 id="getting-started-with-the-firebase-command-line-interface-cli"><a href="#getting-started-with-the-firebase-command-line-interface-cli" class="header-anchor">#</a> Getting started with the Firebase Command Line Interface (CLI)</h2> <p>According to the documentation, &quot;The Firebase CLI provides a variety of tools for managing, viewing, and deploying to Firebase projects&quot;. I have found it to be a powerful tool.</p> <p>The Firebase CLI is simple to install:</p> <ul><li>First, ensure that you have Node.js v8.0.0 or later installed (this should be the case)</li> <li>Next, from within a terminal or shell run <code>npm install -g firebase-tools</code>. The <code>-g</code> option globally installs <code>npm</code> packages.</li></ul> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <h2 id="task-1-getting-started-with-the-cli-and-deploying-to-hosting"><a href="#task-1-getting-started-with-the-cli-and-deploying-to-hosting" class="header-anchor">#</a> Task 1 - Getting Started with the CLI and Deploying to Hosting</h2> <ol><li>Use the steps above to install the CLI</li> <li>Within the terminal authenticate the CLI by running <code>firebase login</code></li> <li>Next, within the terminal, navigate to the root of your goal tracking application and run <code>firebase init</code>.</li></ol> <p>The video below that walks you through setting up the CLI products that we need. When prompted, you will need to make sure that you select the firebase project that contains your goal tracking application.</p> <iframe src="https://solent.cloud.panopto.eu/Panopto/Pages/Embed.aspx?id=d38c636e-ff2c-4ac0-ae7b-ab8700c9e84b&amp;autoplay=false&amp;offerviewer=true&amp;showtitle=true&amp;showbrand=false&amp;start=0&amp;interactivity=all" width="720" height="405" allowfullscreen="allowfullscreen" allow="autoplay" style="border:1px solid #464646;"></iframe> <ol start="4"><li>We are now ready to deploy our application to the firebase hosting:</li></ol> <ul><li><p>First, create a production build of your project, <code>npm run build</code>
After this command has run you should see a 'build' folder containing your production-ready application.</p></li> <li><p>Next, deploy the project to firebase hosting, you simply need to run the command <code>firebase deploy --only hosting</code></p></li> <li><p>That's it! If all has worked, your application should have been deployed to its own custom URL. You may want to add the hosting deployment command, and further commands you use, to your scripts object in your <code>package.json</code> file.</p></li></ul></div> <h2 id="securing-your-firebase-database"><a href="#securing-your-firebase-database" class="header-anchor">#</a> Securing your Firebase Database</h2> <p>Currently our database is not locked down and users can perform any operation they like. To solve this problem, we can use firebase security rules to secure our database.</p> <p>Firebase rules are written in a simple language called Common Expression Language (CEL). Luckily, CEL is similar to JavaScript, albeit somewhat more limiting.</p> <p>Your projects rules are stored in the <code>firestore.rules</code> file. Currently, your application is not locked down. Replace the existing rules with the following code snippet:</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code>
rules_version <span class="token operator">=</span> <span class="token string">'2'</span><span class="token punctuation">;</span>
service cloud<span class="token punctuation">.</span>firestore <span class="token punctuation">{</span>
  match <span class="token operator">/</span>databases<span class="token operator">/</span><span class="token punctuation">{</span>database<span class="token punctuation">}</span><span class="token operator">/</span>documents <span class="token punctuation">{</span>

    match <span class="token operator">/</span><span class="token punctuation">{</span>document<span class="token operator">=</span><span class="token operator">**</span><span class="token punctuation">}</span> <span class="token punctuation">{</span>
          allow read<span class="token punctuation">,</span> write<span class="token operator">:</span> <span class="token keyword">if</span> request<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>uid <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><p>The above code is an example ensures that only logged in users can read/write to our database. Let's explore what is going on above:</p> <ul><li><p>First, we use the wild card to match all documents <code>{document=**}</code>.</p></li> <li><p>We then list the operations that we want to allow - <code>allow read, write</code>. You should note that write captures - create, update and delete.</p></li> <li><p>Finally, we set a condition, <code>if request.auth.uid != null;</code>, should this condition resolve to true the operation is allowed.</p></li> <li><p><code>request</code> is a global var that firebase makes available to us. If <code>request.auth.uid != null;</code> is set then the user is logged-in.</p></li> <li><p>We can deploy our new updated rules by running: <code>firebase deploy --only firestore:rules</code>.</p></li></ul> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <h2 id="task-2"><a href="#task-2" class="header-anchor">#</a> Task 2</h2> <ul><li>Using the steps above secure your database so only logged in users can read and write to your database</li> <li>From within the database section in your firebase project, click on the rules tab - these rules should mirror your local version</li> <li>See if you can figure out how to test if your rules work. You can use the &quot;rules playground&quot; to see if this the case</li></ul></div> <h2 id="increasing-the-granularity-of-our-rules"><a href="#increasing-the-granularity-of-our-rules" class="header-anchor">#</a> Increasing the granularity of our rules</h2> <p>Currently, our application is wide-open to any logged-in user. This is only slightly better than having no authentication at all. Luckily, firebase allows us to protect each collection and sub-collection on a granular level - it even affords us the ability to evaluate the incoming data and, for complex rules, access other documents. Let's explore some of these ideas to make our database more secure:</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code>
rules_version <span class="token operator">=</span> <span class="token string">'2'</span><span class="token punctuation">;</span>
service cloud<span class="token punctuation">.</span>firestore <span class="token punctuation">{</span>
  match <span class="token operator">/</span>databases<span class="token operator">/</span><span class="token punctuation">{</span>database<span class="token punctuation">}</span><span class="token operator">/</span>documents <span class="token punctuation">{</span>
    match <span class="token operator">/</span>checkins<span class="token operator">/</span><span class="token punctuation">{</span>checkin<span class="token punctuation">}</span> <span class="token punctuation">{</span>
      allow read<span class="token operator">:</span> <span class="token keyword">if</span> request<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>uid <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      allow write <span class="token operator">:</span> <span class="token keyword">if</span> request<span class="token punctuation">.</span>resource<span class="token punctuation">.</span>data<span class="token punctuation">.</span>userId <span class="token operator">==</span> request<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>uid   <span class="token comment">// users can only check themselves in</span>
    <span class="token punctuation">}</span>

  <span class="token punctuation">}</span>
</code></pre></div><ul><li><p>In the above example, we lock down down documents on a collection-by-collection basis. Notice how we can access the incoming data, <code>request.resource.data.userId == request.auth.uid</code>. This ensures that a user can only check themselves in. However, any logged-in user can read the data.</p></li> <li><p>Finally, the only other collection we need to consider is comments. Comments are interesting as they are a sub-collection of a checkin document. To begin with let's make all documents within a comments collection insecure. Notice how we nest the rule for a sub-collection within its parent collection:</p></li></ul> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code>    <span class="token operator">...</span>
    match <span class="token operator">/</span>checkins<span class="token operator">/</span><span class="token punctuation">{</span>checkin<span class="token punctuation">}</span> <span class="token punctuation">{</span>
      allow read<span class="token operator">:</span> <span class="token keyword">if</span> request<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>uid <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      allow write <span class="token operator">:</span> <span class="token keyword">if</span> request<span class="token punctuation">.</span>resource<span class="token punctuation">.</span>data<span class="token punctuation">.</span>userId <span class="token operator">==</span> request<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>uid<span class="token punctuation">;</span><span class="token punctuation">;</span>  <span class="token comment">// users can only create a checkin for themselves</span>

      match <span class="token operator">/</span>comments<span class="token operator">/</span><span class="token punctuation">{</span>comment<span class="token punctuation">}</span> <span class="token punctuation">{</span>
        allow read<span class="token punctuation">,</span> write<span class="token operator">:</span> <span class="token keyword">if</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token operator">...</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>Let's now consider how we can secure our comments sub collection - we have two choices here. However, first, let's understand what we are looking to achieve with our security rules.</p> <ul><li>Just like with our checkin documents, we only want users to be able to create comments under their own user id</li> <li>Any logged-in user can view comments</li></ul> <p>Our first solution would be to simply duplicate the logic that we have already used for the parent checkin collection:</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code>    <span class="token operator">...</span>
    match <span class="token operator">/</span>checkins<span class="token operator">/</span><span class="token punctuation">{</span>checkin<span class="token punctuation">}</span> <span class="token punctuation">{</span>
      allow read<span class="token operator">:</span> <span class="token keyword">if</span> request<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>uid <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      allow write <span class="token operator">:</span> <span class="token keyword">if</span> request<span class="token punctuation">.</span>resource<span class="token punctuation">.</span>data<span class="token punctuation">.</span>userId <span class="token operator">==</span> request<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>uid<span class="token punctuation">;</span>  <span class="token comment">// users can only create a checkin for themselves</span>

      match <span class="token operator">/</span>comments<span class="token operator">/</span><span class="token punctuation">{</span>comment<span class="token punctuation">}</span> <span class="token punctuation">{</span>
        allow read<span class="token operator">:</span> <span class="token keyword">if</span> request<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>uid <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        allow write <span class="token operator">:</span> <span class="token keyword">if</span> request<span class="token punctuation">.</span>resource<span class="token punctuation">.</span>data<span class="token punctuation">.</span>userId <span class="token operator">==</span> request<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>uid<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token operator">...</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>The above solution is fine; however, since the sub-collection shares the same rules as its parent, another solution would be to create a wildcard that cascades the parent rules downwards:</p> <div class="language-JavaScript extra-class"><pre class="language-javascript"><code>    <span class="token operator">...</span>
    match <span class="token operator">/</span>checkins<span class="token operator">/</span><span class="token punctuation">{</span>document<span class="token operator">=</span><span class="token operator">**</span><span class="token punctuation">}</span> <span class="token punctuation">{</span>
      allow read<span class="token operator">:</span> <span class="token keyword">if</span> request<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>uid <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      allow write <span class="token operator">:</span> <span class="token keyword">if</span> request<span class="token punctuation">.</span>resource<span class="token punctuation">.</span>data<span class="token punctuation">.</span>userId <span class="token operator">==</span> request<span class="token punctuation">.</span>auth<span class="token punctuation">.</span>uid<span class="token punctuation">;</span>  <span class="token comment">// users a can only create a checkin and a comment for themselves</span>
      <span class="token operator">...</span>
    <span class="token punctuation">}</span>
</code></pre></div><p>In this instance, I prefer the latter approach. However, since each further sub-collection will inherit the parent security rules, we must use it with caution.</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <h2 id="task-3"><a href="#task-3" class="header-anchor">#</a> Task 3</h2> <p>Use the techniques coved above to secure your database.</p></div></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/web-dev-2022-notes/assets/js/app.1aee1c2e.js" defer></script><script src="/web-dev-2022-notes/assets/js/2.12b928b3.js" defer></script><script src="/web-dev-2022-notes/assets/js/25.3ccb054f.js" defer></script>
  </body>
</html>
